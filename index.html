<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Shaka Player Auto Refresh Token</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.js"></script>
  <style>
    body { margin:0; background:#111; display:flex; justify-content:center; align-items:center; height:100vh; }
    video { width:90%; background:black; }
  </style>
</head>
<body>
<video id="video" controls autoplay></video>

<script>
const API_URL = "https://app.swaxnet.xyz/api/mpd-url";
const BEARER = "51b969b5ddee963de6c75686eb75adfd5709f31fd04335ee0a2654498868";
const CHANNEL_ID = "CH-3974c2cd-9ec4-4d03-82b1-9c993973e487";
const SLUG = "AzamSport1";

let player;
let streamData = {};

async function fetchStreamData() {
    const formData = new URLSearchParams();
    formData.append("channelId", CHANNEL_ID);
    formData.append("slug", SLUG);

    const res = await fetch(API_URL, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + BEARER,
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: formData
    });

    streamData = await res.json();
    console.log("New stream data:", streamData);
}

async function initPlayer() {
    const video = document.getElementById("video");
    player = new shaka.Player(video);

    await fetchStreamData();

    // Add token to license request
    player.getNetworkingEngine().registerRequestFilter((type, request) => {
        if(type === shaka.net.NetworkingEngine.RequestType.LICENSE){
            request.headers["Authorization"] = "Bearer " + streamData.authXmlToken;
        }
    });

    // Configure DRM with licenseUrl from API
    player.configure({
        drm: {
            servers: {
                'com.widevine.alpha': streamData.licenseUrl[0]
            }
        }
    });

    // Load MPD
    await player.load(streamData.mpdUrl[0]);
    console.log("Stream loaded!");

    // Auto-refresh token every 60 seconds
    setInterval(refreshToken, 60000);
}

async function refreshToken() {
    console.log("Refreshing token...");
    await fetchStreamData();

    // Update DRM server token
    player.getNetworkingEngine().registerRequestFilter((type, request) => {
        if(type === shaka.net.NetworkingEngine.RequestType.LICENSE){
            request.headers["Authorization"] = "Bearer " + streamData.authXmlToken;
        }
    });

    // Optionally update license URL (if ever changed)
    player.configure({
        drm: {
            servers: {
                'com.widevine.alpha': streamData.licenseUrl[0]
            }
        }
    });

    console.log("Token & license updated!");
}

document.addEventListener("DOMContentLoaded", initPlayer);
</script>
</body>
</html>

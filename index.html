<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Auto Refresh DRM Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.js"></script>
  <style>
    body { background:#111; margin:0; display:flex; align-items:center; justify-content:center; height:100vh; }
    video { width:90%; background:black; }
  </style>
</head>
<body>

<video id="video" controls autoplay></video>

<script>

// -------------------------------
// CONFIG
// -------------------------------
const API_URL = "https://app.swaxnet.xyz/api/mpd-url";
const BEARER_TOKEN = "51b969b5ddee963de6c75686eb75adfd5709f31fd04335ee0a2654498868";

const CHANNEL_ID = "CH-3974c2cd-9ec4-4d03-82b1-9c993973e487";  // badilisha
const SLUG = "AzamSport1";  // badilisha

// LICENSE URL HAIJABADILIKA
const FIXED_LICENSE_URL = "https://azy4sj9b.anycast.nagra.com/AZY4SJ9B/wvls/contentlicenseservice/v1/licenses";

let player;
let currentToken = "";
let currentMpd = "";

// -------------------------------
// Fetch token/mpd from API
// -------------------------------
async function fetchStreamData() {
  const formData = new URLSearchParams();
  formData.append("channelId", CHANNEL_ID);
  formData.append("slug", SLUG);

  const response = await fetch(API_URL, {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + BEARER_TOKEN,
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: formData
  });

  const data = await response.json();

  currentMpd = data.mpdUrl[0];
  currentToken = data.authXmlToken;

  console.log("TOKEN UPDATED:", currentToken);
}

// -------------------------------
// Initialize Shaka Player
// -------------------------------
async function initPlayer() {
  const video = document.getElementById('video');
  player = new shaka.Player(video);

  await fetchStreamData();

  // Add DRM Token Header Every Time License Is Requested
  player.getNetworkingEngine().registerRequestFilter((type, request) => {
    if (type === shaka.net.NetworkingEngine.RequestType.LICENSE) {
      request.headers["Authorization"] = "Bearer " + currentToken;
    }
  });

  // DRM CONFIG (fixed license URL)
  player.configure({
    drm: {
      servers: {
        'com.widevine.alpha': FIXED_LICENSE_URL
      }
    }
  });

  await player.load(currentMpd);
  console.log("Stream loaded!");

  // Auto refresh token + mpd every 60 seconds
  setInterval(refreshStream, 60000);
}

// -------------------------------
// Refresh Token Without Reloading Player
// -------------------------------
async function refreshStream() {
  console.log("Refreshing stream info from API...");
  await fetchStreamData();
}

document.addEventListener('DOMContentLoaded', initPlayer);

</script>

</body>
</html>

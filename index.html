<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AUTO Token Refresh Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.js"></script>
  <style>
    body { background:#111; margin:0; display:flex; align-items:center; justify-content:center; height:100vh; }
    video { width:90%; background:black; }
  </style>
</head>
<body>

<video id="video" controls autoplay></video>

<script>

// --------------------------------
// CONFIG ONLY — NOTHING HARD CODED
// --------------------------------
const API_URL = "https://app.swaxnet.xyz/api/mpd-url";
const BEARER = "51b969b5ddee963de6c75686eb75adfd5709f31fd04335ee0a2654498868";

const CHANNEL_ID = "CH-3974c2cd-9ec4-4d03-82b1-9c993973e487"; 
const SLUG = "AzamSport1";

let player;
let streamData = {};  // full API response (mpd, license, token)


// --------------------------------
// FUNCTION TO FETCH STREAM DATA
// --------------------------------
async function loadFromAPI() {
    const formData = new URLSearchParams();
    formData.append("channelId", CHANNEL_ID);
    formData.append("slug", SLUG);

    const res = await fetch(API_URL, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + BEARER,
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: formData
    });

    streamData = await res.json();

    console.log("UPDATED DATA FROM API:", streamData);
}


// --------------------------------
// Initialize Shaka Player
// --------------------------------
async function initPlayer() {
    const video = document.getElementById("video");
    player = new shaka.Player(video);

    // Get initial stream info
    await loadFromAPI();

    // Attach DRM token automatically
    player.getNetworkingEngine().registerRequestFilter((type, request) => {
        if (type === shaka.net.NetworkingEngine.RequestType.LICENSE) {
            request.headers["Authorization"] = "Bearer " + streamData.authXmlToken;
        }
    });

    // DRM + LICENSE URL FROM API
    player.configure({
        drm: {
            servers: {
                "com.widevine.alpha": streamData.licenseUrl[0]
            }
        }
    });

    // Load MPD from API
    await player.load(streamData.mpdUrl[0]);

    console.log("Stream Loaded!");
    
    // Start auto-refresh every 60 seconds
    setInterval(refreshData, 60000);
}


// --------------------------------
// AUTO REFRESH DATA — NO RELOAD
// --------------------------------
async function refreshData() {
    console.log("AUTO REFRESHING TOKEN & MPD FROM API...");

    await loadFromAPI();

    // Update DRM token
    player.getConfiguration().drm.servers["com.widevine.alpha"] = streamData.licenseUrl[0];

    console.log("Token & License Updated.");
}


// --------------------------------
document.addEventListener("DOMContentLoaded", initPlayer);

</script>

</body>
</html>

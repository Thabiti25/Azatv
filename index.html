<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SwaxNet Web Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.8/shaka-player.compiled.js"></script>
</head>
<body>
  <video id="video" controls autoplay style="width:100%; height:auto;"></video>

  <script>
    async function startPlayer() {
      const video = document.getElementById('video');
      const player = new shaka.Player(video);

      // DRM license proxy
      player.configure({
        drm: { servers: { "com.widevine.alpha": "/api/license" } },
        streaming: { bufferingGoal:30, rebufferingGoal:15, smallGapLimit:0.5 },
        abr: { enabled:true }
      });

      player.getNetworkingEngine().registerRequestFilter((type, request) => {
        if (type === shaka.net.NetworkingEngine.RequestType.LICENSE) {
          request.headers['Content-Type'] = 'application/octet-stream';
        }
      });

      // Fetch MPD from your server
      const mpdResponse = await fetch('/api/mpd', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ channelId: 'CH-3974c2cd-9ec4-4d03-82b1-9c993973e487', slug: 'AzamSport1' })
      });
      const mpdData = await mpdResponse.json();
      const mpdUrl = mpdData.stream || mpdData.url;

      if (!mpdUrl) {
        console.error('No MPD URL returned from server.');
        return;
      }

      await player.load(mpdUrl);
      console.log('Stream loaded:', mpdUrl);

      // Auto-refresh MPD every 40â€“50s (token expiry)
      setInterval(async () => {
        try {
          const refreshed = await fetch('/api/mpd', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ channelId:'CH-3974c2cd-9ec4-4d03-82b1-9c993973e487', slug:'AzamSport1' })
          });
          const data = await refreshed.json();
          const newMPD = data.stream || data.url;
          if(newMPD) {
            await player.load(newMPD);
            console.log('Refreshed MPD loaded:', newMPD);
          }
        } catch(e) { console.error('Failed to refresh MPD:', e); }
      }, 45000);

    }

    startPlayer();
  </script>
</body>
</html>
